---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import EntryGrid from '@/components/EntryGrid.astro';
import Pagination from '@/components/Pagination.astro';
import { POSTS_PER_PAGE } from '@/consts';

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    const categories = Array.from(
        new Set(posts.map((p) => p.data.category).filter(Boolean)),
    );
    return categories.map((cat) => ({ params: { category: String(cat) } }));
}

const category = String(Astro.params.category);
const posts = (await getCollection('blog'))
    .filter((p) => p.data.category === category)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
const pagePosts = posts.slice(0, POSTS_PER_PAGE);

if (!posts.length) {
    // allow 404 at build-time if unknown category
    throw new Error('Category not found');
}

const title = `Category: ${category}`;
const description = `Posts in category ${category}`;
---

<BaseLayout title={title} description={description}>
    <section>
        <h1 class='mb-4 text-center text-3xl font-bold'>
            Category: {category}
            <span class='text-muted-foreground text-sm'>({posts.length})</span>
        </h1>

        <EntryGrid entries={pagePosts} basePath='/article' />

        <div class='mt-6'>
            <Pagination
                currentPage={1}
                totalPages={totalPages}
                basePath={`/category/${category}`}
                firstPagePath={`/category/${category}`}
            />
        </div>
    </section>
</BaseLayout>
