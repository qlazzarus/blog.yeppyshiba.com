---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import EntryGrid from '@/components/EntryGrid.astro';
import Pagination from '@/components/Pagination.astro';
import { POSTS_PER_PAGE } from '@/consts';

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    const categories = Array.from(
        new Set(posts.map((p) => p.data.category).filter(Boolean)),
    );
    const paths = [];

    for (const cat of categories) {
        const catPosts = posts.filter((p) => p.data.category === cat);
        const totalPages = Math.max(1, Math.ceil(catPosts.length / POSTS_PER_PAGE));
        for (let i = 2; i <= totalPages; i++) {
            paths.push({ params: { category: String(cat), page: String(i) } });
        }
    }

    return paths;
}

const category = String(Astro.params.category);
const page = Number(Astro.params.page);

const posts = (await getCollection('blog'))
    .filter((p) => p.data.category === category)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));

if (isNaN(page) || page < 1 || page > totalPages) {
    throw new Error('Page not found');
}

const start = (page - 1) * POSTS_PER_PAGE;
const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

const title = `Category: ${category} â€” Page ${page}`;
const description = `Posts in category ${category}, page ${page}`;
---

<BaseLayout title={title} description={description}>
    <section>
        <h1 class='mb-4 text-center text-3xl font-bold'>
            Category: {category}
            <span class='text-muted-foreground text-sm'>({posts.length})</span>
        </h1>

        <EntryGrid entries={pagePosts} basePath='/article' />
        <div class='mt-6'>
            <Pagination
                currentPage={page}
                totalPages={totalPages}
                basePath={`/category/${category}`}
                firstPagePath={`/category/${category}`}
            />
        </div>
    </section>
</BaseLayout>
