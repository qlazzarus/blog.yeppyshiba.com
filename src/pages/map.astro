---
import { getCollection } from 'astro:content';
import MapLayout from '@/layouts/MapLayout.astro';
import MapClient from '@/components/MapClient.astro';

const posts = (await getCollection('blog'))
    .filter((p) => p.data.lat && p.data.lng)
    // ì•ˆì •ì ì¸ ì •ë ¬(SEO/UX)
    .sort((a, b) => (b.data.date?.valueOf?.() ?? 0) - (a.data.date?.valueOf?.() ?? 0));

const markers = posts.map((p) => ({
    lat: Number(p.data.lat),
    lng: Number(p.data.lng),
    slug: p.id,
    image: p.data.image ?? null,
    title: p.data.title,
}));

const title = 'Map';
const description =
    'Explore posts on an interactive map. Click markers to see more details.';
---

<MapLayout title={title} description={description}>
    <div class='relative'>
        <button
            type='button'
            onclick='history.back()'
            class='bg-muted text-foreground hover:bg-muted/80 absolute top-4 left-4 z-50 inline-flex items-center gap-2 rounded border px-3 py-2 text-sm shadow'
        >
            â† ë’¤ë¡œê°€ê¸°
        </button>

        {/* âœ… í˜„ì¬ ìœ„ì¹˜: ì˜¤ë¥¸ìª½ í•˜ë‹¨ + ì´ëª¨ì§€ ë²„íŠ¼ */}
        <button
            type='button'
            data-my-location
            class='bg-background text-foreground hover:bg-muted absolute right-4 bottom-4 z-50 inline-flex h-11 w-11 items-center justify-center rounded-full border shadow'
            aria-label='í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™'
            title='í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™'
        >
            ğŸ“
        </button>

        <MapClient markers={markers} />

        {/* âœ… í¬ë¡¤ëŸ¬/SEOìš©: ì§€ë„ì™€ ë³„ê°œë¡œ ë‚´ë¶€ ë§í¬ë¥¼ ë…¸ì¶œ */}
        <section class='hidden'>
            <h2>ì§€ë„ì— ë“±ë¡ëœ ê¸€ ëª©ë¡</h2>
            <ul>
                {
                    posts.map((p) => (
                        <li>
                            <a href={`/article/${p.id}`}>{p.data.title}</a>
                            <div>
                                {p.data.date
                                    ? new Date(p.data.date).toLocaleDateString(
                                          'ko-KR',
                                          {
                                              year: 'numeric',
                                              month: '2-digit',
                                              day: '2-digit',
                                          },
                                      )
                                    : ''}
                                {p.data.parcelAddress}
                            </div>
                        </li>
                    ))
                }
            </ul>

            <noscript>
                <p class='text-muted-foreground mt-3 text-sm'>
                    í˜„ì¬ ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ JavaScriptê°€ êº¼ì ¸ ìˆì–´ ì§€ë„ëŠ” í‘œì‹œë˜ì§€
                    ì•Šì§€ë§Œ, ìœ„ ëª©ë¡ì—ì„œ ê¸€ì„ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </noscript>
        </section>
    </div>
</MapLayout>
