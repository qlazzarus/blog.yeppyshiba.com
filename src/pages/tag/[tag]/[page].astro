---
import { getCollection } from 'astro:content';
import { slugify } from 'transliteration';
import BaseLayout from '@/layouts/BaseLayout.astro';
import EntryGrid from '@/components/EntryGrid.astro';
import Pagination from '@/components/Pagination.astro';
import { POSTS_PER_PAGE } from '@/consts';

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    const tags = Array.from(
        new Set(posts.flatMap((p) => p.data.tags ?? []).map((t) => slugify(t))),
    );
    const paths: Array<{ params: { tag: string; page: string } }> = [];
    for (const t of tags) {
        const tPosts = posts.filter((p) =>
            (p.data.tags ?? []).some((tg) => slugify(tg) === t),
        );
        const total = Math.max(1, Math.ceil(tPosts.length / POSTS_PER_PAGE));
        for (let i = 2; i <= total; i++)
            paths.push({ params: { tag: t, page: String(i) } });
    }
    return paths;
}

const tag = String(Astro.params.tag);
const page = Number(Astro.params.page);

const posts = (await getCollection('blog'))
    .filter((p) => (p.data.tags ?? []).some((t) => slugify(t) === tag))
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
if (isNaN(page) || page < 1 || page > totalPages) throw new Error('Page not found');

const start = (page - 1) * POSTS_PER_PAGE;
const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

let label = tag;
for (const p of posts) {
    const found = (p.data.tags ?? []).find((t) => slugify(t) === tag);
    if (found) {
        label = found;
        break;
    }
}

const title = `Tag: ${label} â€” Page ${page}`;
const description = `Posts tagged ${label}, page ${page}`;
---

<BaseLayout title={title} description={description}>
    <section>
        <h1 class='mb-4 text-center text-3xl font-bold'>
            Tag: {label}
            <span class='text-muted-foreground text-sm'>({posts.length})</span>
        </h1>

        <EntryGrid entries={pagePosts} basePath='/article' />

        <div class='mt-6'>
            <Pagination
                currentPage={page}
                totalPages={totalPages}
                basePath={`/tag/${tag}`}
                firstPagePath={`/tag/${tag}`}
            />
        </div>
    </section>
</BaseLayout>
